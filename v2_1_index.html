<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Â•áÈó®ÈÅÅÁî≤ - Êô∫ËÉΩÈöèË∫´Á≥ªÁªü</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

        :root {
            --primary: #b8905b;
            --accent: #00bfa5;
            --bg: #f5f2ed;
            --white: #ffffff;
            --zinc-800: #27272a;
        }

        body {
            background: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            color: var(--zinc-800);
        }

        /* App Header */
        .app-header {
            background: var(--white);
            width: 100%;
            padding: 18px 0 12px;
            text-align: center;
            border-bottom: 1px solid #e5e0da;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.02);
        }

        .app-header h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: 6px;
            font-family: 'Ma Shan Zheng', cursive;
            color: #222;
        }

        .safe-area {
            width: 100%;
            max-width: 500px;
            padding: 20px 16px 140px;
            box-sizing: border-box;
        }

        .matter-box {
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #dcd3d1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }

        .matter-input {
            width: 100%;
            border: none;
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: bold;
            text-align: center;
            outline: none;
            background: transparent;
        }

        .chart-card {
            background: var(--white);
            border-radius: 16px;
            border: 1px solid #dcd3d1;
            padding: 18px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f9f6f2;
            font-size: 0.95rem;
        }

        .label {
            color: #999;
            font-size: 0.85rem;
        }

        .value {
            color: #333;
            font-weight: 500;
        }

        .value.highlight {
            color: var(--primary);
            font-weight: bold;
        }

        .value.red {
            color: #d32f2f;
            font-weight: bold;
        }

        .bazi-row {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            text-align: center;
            padding: 14px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .bazi-item {
            flex: 1;
        }

        .bazi-l {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 6px;
        }

        .bazi-v {
            font-size: 1.6rem;
            color: #d32f2f;
            font-weight: bold;
        }

        .bazi-v.green {
            color: #2e7d32;
        }

        .grid-container {
            width: 100%;
            background: #444;
            border: 3px solid #444;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: minmax(130px, auto);
            gap: 2px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .palace {
            background: var(--white);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
        }

        .p-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 33.3%;
        }

        .p-unit {
            font-size: 1rem;
            color: #444;
        }

        .p-men {
            font-weight: 900;
            font-size: 1.2rem;
        }

        .p-stem {
            font-size: 1.6rem;
            font-weight: bold;
            font-family: serif;
            line-height: 1;
        }

        .p-yg {
            color: #bbb;
            font-size: 0.85rem;
            margin-right: 2px;
        }

        .xk-o {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 2px;
        }

        .cs-label {
            font-size: 0.65rem;
            color: #999;
            display: none;
        }

        /* Nav Tab - Fixed Layout */
        .nav-tab {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            padding: 12px 0 34px;
            z-index: 2000;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.05);
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #999;
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-btn.nj-on {
            color: var(--accent);
            font-weight: bold;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .nav-text {
            font-size: 0.75rem;
        }

        .btn-m {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            background: var(--accent);
            color: white;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
        }

        .modal-body {
            background: var(--white);
            border-radius: 24px 24px 0 0;
            width: 100%;
            max-width: 500px;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 30px 20px 50px;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
        }

        .nj-bd {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2px solid var(--accent);
            background: white;
            border-radius: 8px;
            padding: 4px 10px;
            color: var(--accent);
            font-weight: bold;
            font-size: 0.8rem;
            display: none;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 4px 10px rgba(0, 191, 165, 0.2);
        }

        #toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 10px 24px;
            border-radius: 50px;
            display: none;
            z-index: 10000;
            font-size: 0.85rem;
        }

        .case-item {
            padding: 15px;
            border-bottom: 1px solid #f9f6f2;
            cursor: pointer;
        }

        .case-n {
            font-weight: bold;
            color: #222;
        }

        .case-t {
            font-size: 0.8rem;
            color: #999;
            margin-top: 4px;
        }
    </style>
</head>

<body class="show-cs-mode-only">
    <div class="app-header">
        <h1>Â•áÈó®ÈÅÅÁî≤</h1>
    </div>
    <div class="safe-area">
        <div class="matter-box"><input type="text" id="matter" class="matter-input" placeholder="ËæìÂÖ•È¢ÑÊµã‰∫ãÈ°π..."></div>
        <div class="chart-card">
            <div class="info-row"><span class="label">Êó•Êúü</span><span class="value"
                    style="display:flex;align-items:center;">
                    <input type="datetime-local" id="dt-pk"
                        style="border:none;outline:none;font-size:1.1rem;color:#c02;font-weight:bold;background:transparent;">
                    <button onclick="pk()"
                        style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 14px;margin-left:8px;font-weight:bold;">Ëµ∑Â±Ä</button>
                </span></div>
            <div class="bazi-row">
                <div class="bazi-item">
                    <div class="bazi-l">Âπ¥Êü±</div>
                    <div class="bazi-v" id="bz-y">--</div>
                </div>
                <div class="bazi-item">
                    <div class="bazi-l">ÊúàÊü±</div>
                    <div class="bazi-v green" id="bz-m">--</div>
                </div>
                <div class="bazi-item">
                    <div class="bazi-l">Êó•Êü±</div>
                    <div class="bazi-v green" id="bz-d">--</div>
                </div>
                <div class="bazi-item">
                    <div class="bazi-l">Êó∂Êü±</div>
                    <div class="bazi-v" id="bz-t">--</div>
                </div>
            </div>
            <div class="info-row"><span class="label">ËäÇÊ∞î</span><span class="value" id="jq-v">--</span></div>
            <div class="info-row"><span class="label">Â±ÄÊï∞</span><span class="value highlight" id="js-v">--</span><span
                    class="label">Êó¨È¶ñ</span><span class="value highlight" id="xs-v">--</span></div>
            <div class="info-row"><span class="label">ÂÄºÁ¨¶ÂÄº‰Ωø</span><span class="value" id="zfzs-v"
                    style="color:var(--primary)">--</span></div>
            <div class="info-row"><span class="label">Á©∫‰∫°È©¨Êòü</span><span class="value red" id="xkm-v">--</span></div>
        </div>
        <div class="grid-container" id="grid"></div>
        <div id="note-card"
            style="display:none;background:white;padding:16px;border-radius:12px;margin-top:16px;border:1px solid #ddd;">
            <div style="font-weight:bold;color:var(--primary);margin-bottom:8px;">Ê°£Ê°àËÆ∞ÂΩï</div>
            <div id="note-body" style="font-size:0.95rem; line-height:1.6; color:#666; white-space:pre-wrap;"></div>
        </div>
        <div class="action-btns" style="display:flex;gap:12px;margin-top:20px;">
            <button class="btn-m" onclick="step(-2)">‚óÄ ‰∏ä‰∏ÄÂ±Ä</button>
            <button class="btn-m" style="background:#8b7355;color:white" onclick="toggleCS()">ÊòæÁ§∫ÈïøÁîü</button>
            <button class="btn-m" onclick="step(2)">‰∏ã‰∏ÄÂ±Ä ‚ñ∂</button>
        </div>
    </div>

    <div class="nav-tab">
        <div class="nav-btn active" onclick="goNow()"><span class="nav-icon">üïí</span><span class="nav-text">Áé∞Âú®</span>
        </div>
        <div class="nav-btn" onclick="openLib()"><span class="nav-icon">üìÇ</span><span class="nav-text">Ê°£Ê°à</span></div>
        <div class="nav-btn" id="nj-btn" onclick="toggleNJ()"><span class="nav-icon">‚ú®</span><span
                class="nav-text">Á∫≥Âêâ</span></div>
        <div class="nav-btn" onclick="share()"><span class="nav-icon">üñºÔ∏è</span><span class="nav-text">ÂàÜ‰∫´</span></div>
    </div>

    <div id="lib-modal" class="modal">
        <div class="modal-body">
            <span style="position:absolute;top:15px;right:20px;font-size:1.5rem;color:#999;cursor:pointer;"
                onclick="closeM('lib-modal')">&times;</span>
            <h3 style="color:var(--primary);margin:0 0 20px;">Ê°£Ê°àÂ∫ìÊé•ÂÖ•</h3>
            <div id="drop-box"
                style="border:2px dashed #ddd;border-radius:16px;padding:40px 20px;text-align:center;color:#999;margin-bottom:20px;cursor:pointer;">
                üìÇ ÁÇπÂáªÊàñÊãñÊãΩ cases.db Âà∞Ê≠§</div>
            <div id="c-list"></div>
        </div>
    </div>
    <div id="toast"></div>

    <script>
        const TI = ['Áî≤', '‰πô', '‰∏ô', '‰∏Å', 'Êàä', 'Â∑±', 'Â∫ö', 'Ëæõ', 'Â£¨', 'Áô∏'], DI = ['Â≠ê', '‰∏ë', 'ÂØÖ', 'ÂçØ', 'Ëæ∞', 'Â∑≥', 'Âçà', 'Êú™', 'Áî≥', 'ÈÖâ', 'Êàå', '‰∫•'], SQ = ['Êàä', 'Â∑±', 'Â∫ö', 'Ëæõ', 'Â£¨', 'Áô∏', '‰∏Å', '‰∏ô', '‰πô'], ZO = [1, 8, 3, 4, 9, 2, 7, 6], BO = { 1: '‰ºëÈó®', 2: 'Ê≠ªÈó®', 3: '‰º§Èó®', 4: 'ÊùúÈó®', 6: 'ÂºÄÈó®', 7: 'ÊÉäÈó®', 8: 'ÁîüÈó®', 9: 'ÊôØÈó®' }, XO = { 1: 'Â§©Ëì¨', 2: 'Â§©ËäÆ', 3: 'Â§©ÂÜ≤', 4: 'Â§©ËæÖ', 5: 'Â§©Á¶Ω', 6: 'Â§©ÂøÉ', 7: 'Â§©Êü±', 8: 'Â§©‰ªª', 9: 'Â§©Ëã±' }, BS = ['ÂÄºÁ¨¶', 'Ëû£Ëõá', 'Â§™Èò¥', 'ÂÖ≠Âêà', 'ÁôΩËôé', 'ÁéÑÊ≠¶', '‰πùÂú∞', '‰πùÂ§©'];
        let cT = new Date(), sqlDB = null, showCS = false;

        function syncPK() { document.getElementById('dt-pk').value = new Date(cT.getTime() - cT.getTimezoneOffset() * 60000).toISOString().substring(0, 16); rdr(paipan(cT)); }
        function goNow() { cT = new Date(); syncPK(); }
        function pk() { const v = document.getElementById('dt-pk').value; if (v) { cT = new Date(v); rdr(paipan(cT)); } }
        function step(h) { cT.setHours(cT.getHours() + h); syncPK(); }
        function toggleCS() { showCS = !showCS; Array.from(document.querySelectorAll('.cs-label')).forEach(el => el.style.display = showCS ? 'block' : 'none'); showT(showCS ? 'ÂºÄÂêØÈïøÁîüÊòæÁ§∫' : 'ÂÖ≥Èó≠ÈïøÁîüÊòæÁ§∫'); }
        function toggleNJ() { const b = document.getElementById('nj-btn'); const a = b.classList.toggle('nj-on'); document.querySelectorAll('.nj-bd').forEach(i => i.style.display = a ? 'block' : 'none'); showT(a ? 'Â∑≤ÂºÄÂêØÁ∫≥ÂêâËßÜÈáé' : 'Â∑≤ÂÖ≥Èó≠'); }
        function showT(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); }
        function openLib() { document.getElementById('lib-modal').style.display = 'block'; }
        function closeM(id) { document.getElementById(id).style.display = 'none'; }

        function getXS(gz) { const gi = TI.indexOf(gz[0]), zi = DI.indexOf(gz[1]); return "Áî≤" + DI[(zi - gi + 12) % 12]; }
        function calcCS(g, p) {
            const s = { 'Áî≤': '‰∫•', '‰πô': 'Âçà', '‰∏ô': 'ÂØÖ', '‰∏Å': 'ÈÖâ', 'Êàä': 'ÂØÖ', 'Â∑±': 'ÈÖâ', 'Â∫ö': 'Â∑≥', 'Ëæõ': 'Â≠ê', 'Â£¨': 'Áî≥', 'Áô∏': 'ÂçØ' },
                d = { 'Áî≤': 1, '‰πô': -1, '‰∏ô': 1, '‰∏Å': -1, 'Êàä': 1, 'Â∑±': -1, 'Â∫ö': 1, 'Ëæõ': -1, 'Â£¨': 1, 'Áô∏': -1 },
                st = ["ÈïøÁîü", "Ê≤êÊµ¥", "ÂÜ†Â∏¶", "‰∏¥ÂÆò", "Â∏ùÊó∫", "Ë°∞", "ÁóÖ", "Ê≠ª", "Â¢ì", "Áªù", "ËÉé", "ÂÖª"];
            if (!s[g]) return "";
            const t = { 1: 'Â≠ê', 2: 'Áî≥', 3: 'ÂçØ', 4: 'Â∑≥', 6: 'Êàå', 7: 'ÈÖâ', 8: 'ÂØÖ', 9: 'Âçà', 5: 'Áî≥' }[p];
            const si = DI.indexOf(s[g]), ti = DI.indexOf(t);
            return st[(d[g] === 1 ? (ti - si + 12) % 12 : (si - ti + 12) % 12)];
        }

        function paipan(date) {
            try {
                const sol = window.Solar.fromDate(date), lun = sol.getLunar(), hg = lun.getTimeInGanZhi(), xs = getXS(hg), dg = { 'Áî≤Â≠ê': 'Êàä', 'Áî≤Êàå': 'Â∑±', 'Áî≤Áî≥': 'Â∫ö', 'Áî≤Âçà': 'Ëæõ', 'Áî≤Ëæ∞': 'Â£¨', 'Áî≤ÂØÖ': 'Áô∏' }[xs], jn = lun.getPrevJieQi().getName(), ji = ['ÂÜ¨Ëá≥', 'Â∞èÂØí', 'Â§ßÂØí', 'Á´ãÊò•', 'Èõ®Ê∞¥', 'ÊÉäËõ∞', 'Êò•ÂàÜ', 'Ê∏ÖÊòé', 'Ë∞∑Èõ®', 'Á´ãÂ§è', 'Â∞èÊª°', 'ËäíÁßç', 'Â§èËá≥', 'Â∞èÊöë', 'Â§ßÊöë', 'Á´ãÁßã', 'Â§ÑÊöë', 'ÁôΩÈú≤', 'ÁßãÂàÜ', 'ÂØíÈú≤', 'ÈúúÈôç', 'Á´ãÂÜ¨', 'Â∞èÈõ™', 'Â§ßÈõ™'].indexOf(jn), dayO = (10 + Math.floor((new Date(sol.getYear(), sol.getMonth() - 1, sol.getDay()) - new Date(1900, 0, 1)) / 86400000)) % 60, sy = Math.floor((dayO % 15) / 5), ju = [[1, 7, 4], [2, 8, 5], [3, 9, 6], [8, 5, 2], [9, 6, 3], [1, 7, 4], [3, 9, 6], [4, 1, 7], [5, 2, 8], [4, 1, 7], [5, 2, 8], [6, 3, 9], [9, 3, 6], [8, 2, 5], [7, 1, 4], [2, 5, 8], [1, 4, 7], [9, 3, 6], [7, 1, 4], [6, 9, 3], [5, 8, 2], [6, 9, 3], [5, 8, 2], [4, 7, 1]][ji][sy], dp = {};
                [1, 2, 3, 4, 5, 6, 7, 8, 9].forEach((g, i) => { dp[ji < 12 ? [1, 2, 3, 4, 5, 6, 7, 8, 9][([1, 2, 3, 4, 5, 6, 7, 8, 9].indexOf(ju) + i) % 9] : [1, 2, 3, 4, 5, 6, 7, 8, 9][([1, 2, 3, 4, 5, 6, 7, 8, 9].indexOf(ju) - i + 9) % 9]] = SQ[i]; });
                const xg = Object.keys(dp).find(k => dp[k] === dg), xa = xg == 5 ? 2 : parseInt(xg), sg = hg[0] === 'Áî≤' ? dg : hg[0], sgG = Object.keys(dp).find(k => dp[k] === sg), sa = sgG == 5 ? 2 : parseInt(sgG), st = (DI.indexOf(hg[1]) - DI.indexOf(xs.substring(1)) + 12) % 12; let cg = parseInt(xg); for (let i = 0; i < st; i++)cg = ji < 12 ? (cg == 9 ? 1 : cg + 1) : (cg == 1 ? 9 : cg - 1);
                const zt = cg == 5 ? 2 : cg, get = (g) => ZO.indexOf(g == 5 ? 2 : g), xp = get(xa), sp = get(sa), zp = get(zt), jg = {}, zs = BO[xg] || 'Ê≠ªÈó®';
                for (let n = 1; n <= 9; n++) { if (n == 5) { jg[n] = { dp: dp[5], yg: '' }; continue; } const p = ZO.indexOf(n), xiG = ZO[(p - (sp - xp + 8) % 8 + 8) % 8], meG = ZO[(p - (zp - xp + 8) % 8 + 8) % 8]; jg[n] = { dp: dp[n], tp: dp[xiG] || dp[5], xi: XO[xiG], me: BO[meG] || 'Ê≠ªÈó®', sn: BS[ji < 12 ? (p - sp + 8) % 8 : (sp - p + 8) % 8] }; }
                const ym = {}; for (let i = 0; i < 9; i++)ym[ji < 12 ? (zt + i - 1) % 9 + 1 : (zt - i + 9 - 1) % 9 + 1] = SQ[(SQ.indexOf(sg) + i) % 9]; for (let n = 1; n <= 9; n++)jg[n].yg = ym[n];
                const mk = {}; for (let n = 1; n <= 9; n++) { if (n == 5) continue; const m = { ts: [], gt: {} }; if (['‰º§Èó®', 'ÊùúÈó®'].includes(jg[n].me) && [2, 8].includes(n)) m.ts.push('Èó®Ëø´'); if (['ÂºÄÈó®', 'ÊÉäÈó®'].includes(jg[n].me) && [3, 4].includes(n)) m.ts.push('Èó®Ëø´');[jg[n].tp, jg[n].dp, jg[n].yg].forEach(gan => { const t = []; if ({ 'Â∑±': [2], 'Êàä': [3], 'Â£¨': [4], 'Áô∏': [4], 'Â∫ö': [8], 'Ëæõ': [9] }[gan]?.includes(n)) t.push('ÂáªÂàë'); if ({ 'Áî≤': [2], 'Áô∏': [2], '‰πô': [6], '‰∏ô': [6], 'Êàä': [6], '‰∏Å': [8], 'Â∑±': [8], 'Â∫ö': [8], 'Ëæõ': [4], 'Â£¨': [4] }[gan]?.includes(n)) t.push('ÂÖ•Â¢ì'); m.gt[gan] = t; }); mk[n] = m; }
                return { lu: lun, jg, zf: XO[xa], zs, xs, du: ji < 12 ? 'Èò≥ÈÅÅ' : 'Èò¥ÈÅÅ', ju, sy: ['‰∏äÂÖÉ', '‰∏≠ÂÖÉ', '‰∏ãÂÖÉ'][sy], jq: jn, xk: lun.getEightChar().getDayXunKong(), ym: { 'Áî≥': 8, 'Â≠ê': 8, 'Ëæ∞': 8, 'ÂØÖ': 2, 'Âçà': 2, 'Êàå': 2, 'Â∑≥': 6, 'ÈÖâ': 6, '‰∏ë': 6, '‰∫•': 4, 'ÂçØ': 4, 'Êú™': 4 }[hg[1]], mk };
            } catch (e) { return null; }
        }

        function rdr(r) {
            if (!r) return;
            document.getElementById('jq-v').innerText = r.jq;
            document.getElementById('js-v').innerText = r.du + r.ju + 'Â±Ä(' + r.sy + ')';
            document.getElementById('xs-v').innerText = r.xs;
            document.getElementById('zfzs-v').innerText = `Á¨¶Ôºö${r.zf} / ‰ΩøÔºö${r.zs}`;
            document.getElementById('xkm-v').innerText = `Á©∫Ôºö${r.xk} È©¨Ôºö${["", "Âùé1", "Âù§2", "Èúá3", "Â∑Ω4", "‰∏≠5", "‰πæ6", "ÂÖë7", "ËâÆ8", "Á¶ª9"][r.ym]}`;
            const bzv = [r.lu.getYearInGanZhiExact(), r.lu.getMonthInGanZhiExact(), r.lu.getDayInGanZhiExact(), r.lu.getTimeInGanZhi()];
            ['bz-y', 'bz-m', 'bz-d', 'bz-t'].forEach((id, i) => document.getElementById(id).innerText = bzv[i]);
            const g = document.getElementById('grid'); g.innerHTML = '';
            [4, 9, 2, 3, 5, 7, 8, 1, 6].forEach(n => {
                const f = r.jg[n], w = document.createElement('div'); w.className = 'palace';
                if (n === 5) { w.innerHTML = `<div style="height:100%;display:flex;justify-content:center;align-items:center;"><span class="p-stem" style="color:#ddd">${f.dp}</span></div>`; g.appendChild(w); return; }
                const getS = t => t?.includes('ÂáªÂàë') ? 'color:#8b00cc;' : t?.includes('Èó®Ëø´') ? 'color:#cc0000;' : '';

                // --- Essential Na Ji Logic ---
                let njH = ""; const njR = { 1: ['‰ºëÈó®'], 2: ['ÁîüÈó®'], 6: ['ÂºÄÈó®'], 8: ['ÁîüÈó®'], 9: ['ÊôØÈó®'] };
                if (njR[n]?.includes(f.me) && !r.mk[n].ts.includes('Èó®Ëø´') && !Object.values(r.mk[n].gt).flat().includes('ÂáªÂàë') && f.sn !== 'ÁôΩËôé') {
                    njH = `<div class="nj-bd" style="display:${document.getElementById('nj-btn').classList.contains('nj-on') ? 'block' : 'none'}">Á∫≥Âêâ</div>`;
                }

                w.innerHTML = `${njH}
                    <div class="p-row">
                        <span class="p-unit">${r.xk.includes(DI[["", 0, 7, 2, 4, 0, 10, 8, 1, 6][n]]) ? '<span class="xk-o">‚óã</span>' : ''}${f.sn}</span>
                        <span>${n === r.ym ? 'üêé' : ''}</span>
                    </div>
                    <div class="p-row">
                        <div><span class="p-yg">${f.yg}</span><span class="p-unit">${f.xi}</span></div>
                        <div style="text-align:right">
                            <span class="cs-label" style="display:${showCS ? 'block' : 'none'}">${calcCS(f.tp, n)}</span>
                            <span class="p-stem">${f.tp}</span>
                        </div>
                    </div>
                    <div class="p-row">
                        <span class="p-men" style="${getS(r.mk[n].ts)}">${f.me}</span>
                        <div style="text-align:right">
                            <span class="cs-label" style="display:${showCS ? 'block' : 'none'}">${calcCS(f.dp, n)}</span>
                            <span class="p-stem">${f.dp}</span>
                        </div>
                    </div>`;
                g.appendChild(w);
            });
        }

        // --- Database & Persistence ---
        function saveDB(arrayBuffer) {
            const request = indexedDB.open('QimenDBStore', 1);
            request.onupgradeneeded = e => e.target.result.createObjectStore('dbFile');
            request.onsuccess = e => {
                const db = e.target.result;
                const tx = db.transaction('dbFile', 'readwrite');
                tx.objectStore('dbFile').put(arrayBuffer, 'current');
            };
        }

        async function initSQL(buffer) {
            const config = { locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${file}` };
            const SQL = await initSqlJs(config);
            sqlDB = new SQL.Database(new Uint8Array(buffer));
            const res = sqlDB.exec("SELECT name, chart_time, notes, id FROM cases ORDER BY chart_time DESC");
            if (res.length > 0) {
                document.getElementById('c-list').innerHTML = res[0].values.map(v => `
                    <div class="case-item" onclick="loadC('${v[0]}','${v[1]}','${v[2]}')">
                        <div class="case-n">${v[0] || 'Êú™ÂÆö‰∫ãÈ°π'}</div>
                        <div class="case-t">${v[1]}</div>
                    </div>`).join('');
            }
        }

        function loadC(m, dt, n) {
            document.getElementById('matter').value = m;
            document.getElementById('dt-pk').value = dt.replace(' ', 'T');
            document.getElementById('note-body').innerText = n || 'Êó†Á¨îËÆ∞ËÆ∞ÂΩï';
            document.getElementById('note-card').style.display = 'block';
            pk(); closeM('lib-modal');
        }

        const drop = document.getElementById('drop-box');
        drop.onclick = () => { const i = document.createElement('input'); i.type = 'file'; i.onchange = e => handleF(e.target.files[0]); i.click(); };
        drop.ondragover = e => { e.preventDefault(); drop.style.borderColor = 'var(--accent)'; };
        drop.ondragleave = () => drop.style.borderColor = '#ddd';
        drop.ondrop = e => { e.preventDefault(); handleF(e.dataTransfer.files[0]); };
        function handleF(file) {
            if (!file) return;
            const r = new FileReader();
            r.onload = e => { saveDB(e.target.result); initSQL(e.target.result); };
            r.readAsArrayBuffer(file);
            showT('Ê≠£Âú®Ëß£ÊûêÊ°£Ê°àÂ∫ì...');
        }

        function share() { showT('ÁîüÊàê‰∏≠...'); html2canvas(document.body).then(v => { const a = document.createElement('a'); a.download = 'QiMen_Card.png'; a.href = v.toDataURL(); a.click(); }); }
        window.onload = () => {
            syncPK();
            const request = indexedDB.open('QimenDBStore', 1);
            request.onsuccess = e => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('dbFile')) return;
                const tx = db.transaction('dbFile', 'readonly');
                tx.objectStore('dbFile').get('current').onsuccess = event => {
                    if (event.target.result) initSQL(event.target.result);
                };
            };
        };
    </script>
</body>

</html>