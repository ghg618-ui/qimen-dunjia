<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>å¥‡é—¨éç”² - æ™ºèƒ½æ’ç›˜ç³»ç»Ÿ</title>
    <!-- ä½¿ç”¨ lunar-javascript åº“å¤„ç†å†æ³• -->
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');
        body { background:#f5f2ed; font-family:"Microsoft YaHei",sans-serif; display:flex; flex-direction:column; align-items:center; padding:20px; margin:0; -webkit-tap-highlight-color: transparent; }
        .header { text-align:center; margin-bottom:15px; color:#333; }
        .header h1 { margin:0; font-size:1.4rem; letter-spacing:4px; font-weight:normal; font-family: 'Ma Shan Zheng', cursive; }
        
        .main-info { background:#fff; border:1px solid #dcd3d1; padding:15px; width:100%; max-width:600px; margin-bottom:5px; box-sizing:border-box; border-radius:12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .info-r { display:flex; justify-content:space-between; margin-bottom:8px; border-bottom:1px solid #f9f6f2; padding-bottom:4px; font-size:0.95rem; align-items:center; }
        .lbl { color:#777; width:65px; display:inline-block; } .val { color:#333; flex-grow:1; text-align:left; }
        .kv { color:#c02; font-weight: bold; }
        
        .bazi-grid { display:flex; gap:10px; margin: 10px 0; border-top:1px solid #eee; border-bottom:1px solid #eee; padding:10px 0; text-align:center; }
        .bazi-col { flex:1; display:flex; flex-direction:column; }
        .bazi-lbl { color:#b8905b; font-size:0.85rem; margin-bottom:5px; }
        .bazi-val { font-size:1.6rem; color:#d32f2f; font-weight:bold; }
        .bazi-val.green { color:#2e7d32; }

        .grid {
            display: grid; grid-template-columns: repeat(3, 1fr); grid-auto-rows: 140px;
            background: #333; border: 2px solid #333; gap: 1.5px; width: 100%; max-width: 600px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 4px; overflow: hidden;
        }
        .palace-wrapper { position: relative; background: #fff; cursor: pointer; transition: background 0.2s; }
        .palace-wrapper:active { background: #f9f9f9; }
        .palace { height:100%; padding: 8px; display: flex; flex-direction: column; box-sizing: border-box; }
        
        .p-row { display: flex; justify-content: space-between; align-items: center; min-height: 33.33%; }
        .p-left { display: flex; align-items: center; white-space: nowrap; }
        .p-right { display: flex; flex-direction: column; align-items: flex-end; justify-content: center; }
        .p-shen { font-size: 1.1rem; color: #333; }
        .p-xing { font-size: 1.15rem; color: #333; }
        .p-men { font-size: 1.15rem; color: #333; font-weight: bold; }
        .p-stem { font-size: 1.5rem; line-height: 1; white-space: nowrap; position: relative; font-weight:bold; font-family: serif; }
        .p-yingan { color: #aaa; font-size: 0.9rem; margin-right: 2px; }
        .circle { color: #1a9c3e; margin-right: 2px; font-weight: bold; }
        .ma-ext { font-size: 1.1rem; color:#00bfa5; }
        
        /* Badges */
        .naji-badge {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(212, 237, 218, 0.95); color: #155724; border: 2px solid #28a745;
            border-radius: 8px; padding: 6px 12px; font-size: 1.2rem; font-weight: bold;
            z-index: 20; box-shadow: 0 4px 8px rgba(0,0,0,0.3); animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.6); }
            70% { transform: translate(-50%, -50%) scale(1.1); box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }

        /* Bottom Nav */
        .bottom-nav {
            position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%);
            width: 92%; max-width: 500px; background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); border: 1px solid rgba(184, 144, 91, 0.2);
            border-radius: 40px; display: flex; justify-content: space-around;
            padding: 10px 5px; z-index: 1000; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: #8b7355; font-size: 0.7rem; cursor: pointer; flex:1; }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-item.active-nj { color: #28a745; font-weight: bold; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 10000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: #fff; margin: 15% auto; padding: 20px; border-radius: 12px; width: 85%; max-width: 450px; position: relative; max-height: 80vh; overflow-y: auto; }
        .close { float: right; font-size: 24px; cursor: pointer; color: #999; }
        
        /* CS Status */
        .stem-group { display: flex; flex-direction: column; align-items: center; position: relative; margin: 0 2px; }
        .cs-label { display: none; position: absolute; bottom: 100%; font-size: 0.65rem; color: #888; white-space: nowrap; margin-bottom: 4px; }
        body.show-cs .cs-label { display: block; }
        
        .action-bar { margin: 20px 0 100px 0; display: flex; gap: 8px; width: 100%; max-width: 600px; }
        .action-btn { flex: 1; padding: 12px; background: #00bfa5; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; text-align: center; }
        
        .dt-input { font-size:1rem; border:1px solid #ccc; border-radius:8px; padding:6px; flex-grow:1; outline:none; }
        .dt-btn { background:#00bfa5; color:white; border:none; border-radius:8px; padding:8px 15px; cursor:pointer; font-weight:bold; margin-left:5px; }
        
        #toast { pointer-events: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); color: white; padding: 12px 24px; border-radius: 30px; z-index: 20000; display: none; text-align: center; }
        
        @media (max-width: 400px) {
            .p-stem { font-size: 1.2rem; }
            .p-xing, .p-men { font-size: 1rem; }
            .grid { grid-auto-rows: 120px; }
        }
    </style>
</head>
<body>

<div class="header"><h1>å¥‡é—¨éç”²</h1></div>

<div class="main-info">
    <div class="info-r" style="border-bottom: none; margin-bottom: 5px;">
        <span class="val" style="color:#b8905b; font-weight:bold; letter-spacing:1px;">è½¬ç›˜å¥‡é—¨ Â· å¯„å¤ Â· ç½®é—° Â· æ¼”ç¤ºç‰ˆ</span>
    </div>
    <div class="info-r" style="padding: 2px 0;">
        <span class="lbl">æ—¥æœŸ</span>
        <span class="val" style="display:flex; align-items:center;">
            <input type="datetime-local" id="custom-dt" class="dt-input">
            <button class="dt-btn" onclick="jumpToDate()">æ’ç›˜</button>
        </span>
    </div>
    <div class="bazi-grid" id="bazi-display">
       <div class="bazi-col"><div class="bazi-lbl">å¹´æŸ±</div><div class="bazi-val">--</div></div>
       <div class="bazi-col"><div class="bazi-lbl">æœˆæŸ±</div><div class="bazi-val green">--</div></div>
       <div class="bazi-col"><div class="bazi-lbl">æ—¥æŸ±</div><div class="bazi-val green">--</div></div>
       <div class="bazi-col"><div class="bazi-lbl">æ—¶æŸ±</div><div class="bazi-val">--</div></div>
    </div>
    <div class="info-r"><span class="lbl">èŠ‚æ°”</span><span class="val" id="jieqi-val">--</span></div>
    <div class="info-r">
        <span class="lbl">å±€æ•°</span><span class="val" style="color:#666" id="jushu-val">--</span>
        <span class="lbl">æ—¬é¦–</span><span class="val" style="color:#666" id="xunshou-val">--</span>
    </div>
    <div class="info-r">
        <span class="lbl">å€¼ç¬¦</span><span class="val" style="color:#b8905b" id="zhifu-val">--</span>
        <span class="lbl">å€¼ä½¿</span><span class="val" style="color:#b8905b" id="zhishi-val">--</span>
    </div>
    <div class="info-r" style="border-bottom:none; margin-bottom:0;">
        <span class="lbl">ç©ºäº¡</span><span class="val kv" id="xunkong-val">--</span>
        <span class="lbl">é©¬æ˜Ÿ</span><span class="val kv" id="yima-val">--</span>
    </div>
</div>

<div class="grid" id="qimen-grid">
    <!-- Palaces will be injected here -->
</div>

<div class="action-bar">
    <div class="action-btn" onclick="stepTime(-2)">â—€ ä¸Šä¸€å±€</div>
    <div class="action-btn" style="background:#6c757d" onclick="toggleCS()">é•¿ç”ŸçŠ¶æ€</div>
    <div class="action-btn" onclick="stepTime(2)">ä¸‹ä¸€å±€ â–¶</div>
</div>

<div class="bottom-nav">
    <div class="nav-item" onclick="resetToNow()"><span class="nav-icon">ğŸ </span><span>ç°åœ¨</span></div>
    <div class="nav-item" onclick="shareChart()"><span class="nav-icon">ğŸ“¤</span><span>åˆ†äº«</span></div>
    <div class="nav-item" id="nav-naji" onclick="toggleNaji()"><span class="nav-icon">âœ¨</span><span>çº³å‰</span></div>
    <div class="nav-item" onclick="showHelp()"><span class="nav-icon">â“</span><span>è¯´æ˜</span></div>
</div>

<div id="toast"></div>

<!-- Modals -->
<div id="najiModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('najiModal')">&times;</span>
        <div id="naji-content"></div>
    </div>
</div>

<div id="helpModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('helpModal')">&times;</span>
        <h2 style="color:#b8905b">å¥‡é—¨éç”² - æ¼”ç¤ºç‰ˆè¯´æ˜</h2>
        <p>1. æœ¬æ¼”ç¤ºç‰ˆé‡‡ç”¨<b>ç½®é—°æ³•</b>æ’ç›˜ï¼Œé€šè¿‡ <i>lunar-javascript</i> è®¡ç®—é«˜ç²¾åº¦å†æ³•ã€‚</p>
        <p>2. ç‚¹å‡»<b>çº³å‰</b>å¯å¼€å¯å‰ä½è§†è§‰æç¤ºã€‚</p>
        <p>3. é™æ€ç‰ˆæš‚ä¸æ”¯æŒä¿å­˜æ¡ˆä¾‹åº“ï¼Œä»…ä¾›æŸ¥çœ‹å’Œæ’ç›˜æ¨æ¼”ã€‚</p>
    </div>
</div>

<div id="palaceModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('palaceModal')">&times;</span>
        <h3 id="palace-title" style="color:#b8905b"></h3>
        <div id="palace-content"></div>
    </div>
</div>

<script>
// ---------- Core Constants & Data ----------
const TIANGAN = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
const DIZHI = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
const SANQI_LIUYI = ['æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ä¸', 'ä¸™', 'ä¹™'];
const ZHUANPAN_ORDER = [1, 8, 3, 4, 9, 2, 7, 6];
const BAMEN_ORIG = { 1: 'ä¼‘é—¨', 2: 'æ­»é—¨', 3: 'ä¼¤é—¨', 4: 'æœé—¨', 6: 'å¼€é—¨', 7: 'æƒŠé—¨', 8: 'ç”Ÿé—¨', 9: 'æ™¯é—¨' };
const JIUXING_ORIG = { 1: 'å¤©è“¬', 2: 'å¤©èŠ®', 3: 'å¤©å†²', 4: 'å¤©è¾…', 5: 'å¤©ç¦½', 6: 'å¤©å¿ƒ', 7: 'å¤©æŸ±', 8: 'å¤©ä»»', 9: 'å¤©è‹±' };
const BASHEN = ['å€¼ç¬¦', 'è£è›‡', 'å¤ªé˜´', 'å…­åˆ', 'ç™½è™', 'ç„æ­¦', 'ä¹åœ°', 'ä¹å¤©'];

const NAJI_VALID_DOORS = {
    1: ['å¼€é—¨'], 2: ['å¼€é—¨', 'æ™¯é—¨'], 3: ['ä¼‘é—¨', 'æ™¯é—¨'], 4: ['ä¼‘é—¨', 'æ™¯é—¨'], 
    6: ['ä¼‘é—¨', 'ç”Ÿé—¨'], 7: ['ä¼‘é—¨', 'ç”Ÿé—¨', 'å¼€é—¨'], 8: ['å¼€é—¨', 'æ™¯é—¨'], 9: ['ç”Ÿé—¨']
};

const NAJI_COLORS = { "ç”²": "ç»¿", "ä¹™": "æµ…ç»¿", "ä¸™": "çº¢", "ä¸": "æµ…çº¢", "æˆŠ": "æ£•é»„", "å·±": "æµ…é»„", "åºš": "ç™½", "è¾›": "é‡‘", "å£¬": "è“é»‘", "ç™¸": "æµ…è“" };

// ---------- Core Logic Port ----------

let currentDate = new Date();

function updateGanzhiDisplay(lunar) {
    const gzYear = lunar.getYearInGanZhiExact();
    const gzMonth = lunar.getMonthInGanZhiExact();
    const gzDay = lunar.getDayInGanZhiExact();
    const gzTime = lunar.getTimeInGanZhi();
    
    const vals = document.querySelectorAll('.bazi-val');
    vals[0].innerText = gzYear;
    vals[1].innerText = gzMonth;
    vals[2].innerText = gzDay;
    vals[3].innerText = gzTime;
}

function getXunShou(gz) {
    const gi = TIANGAN.indexOf(gz[0]);
    const zi = DIZHI.indexOf(gz[1]);
    const xs_zi = (zi - gi + 12) % 12;
    return "ç”²" + DIZHI[xs_zi];
}

function getDunGan(xs) {
    const map = { 'ç”²å­': 'æˆŠ', 'ç”²æˆŒ': 'å·±', 'ç”²ç”³': 'åºš', 'ç”²åˆ': 'è¾›', 'ç”²è¾°': 'å£¬', 'ç”²å¯…': 'ç™¸' };
    return map[xs] || 'æˆŠ';
}

function getJuShu(lunar) {
    // Port of the Zhizun intercalation logic
    // For simplicity in this demo, we use the standard intercalation provided by lunar-javascript or approximate
    // But since the user wants the exact logic, we'll try to follow the "Best Jieqi" proximity rule.
    
    // In actual JS library, we can get the nearest jieqi easily.
    const prevJQ = lunar.getPrevJieQi();
    const nextJQ = lunar.getNextJieQi();
    
    // Get Day GanZhi as standard day-offset
    const dayGz = lunar.getDayInGanZhiExact();
    const gi = TIANGAN.indexOf(dayGz[0]);
    const zi = DIZHI.indexOf(dayGz[1]);
    const dayOrder = 0; // Calculated below
    
    // Simple version of JuShu calculation (matchesç…™æ³¢é‡£åŸæ­Œ)
    const jqTable = [
        /*å†¬è‡³*/[1,7,4], [2,8,5], [3,9,6], [8,5,2], [9,6,3], [1,7,4],
        /*æ˜¥åˆ†*/[3,9,6], [4,1,7], [5,2,8], [4,1,7], [5,2,8], [6,3,9],
        /*å¤è‡³*/[9,3,6], [8,2,5], [7,1,4], [2,5,8], [1,4,7], [9,3,6],
        /*ç§‹åˆ†*/[7,1,4], [6,9,3], [5,8,2], [6,9,3], [5,8,2], [4,7,1]
    ];
    
    const jqName = prevJQ.getName();
    const jqNames = ['å†¬è‡³', 'å°å¯’', 'å¤§å¯’', 'ç«‹æ˜¥', 'é›¨æ°´', 'æƒŠè›°', 'æ˜¥åˆ†', 'æ¸…æ˜', 'è°·é›¨', 'ç«‹å¤', 'å°æ»¡', 'èŠ’ç§', 'å¤è‡³', 'å°æš‘', 'å¤§æš‘', 'ç«‹ç§‹', 'å¤„æš‘', 'ç™½éœ²', 'ç§‹åˆ†', 'å¯’éœ²', 'éœœé™', 'ç«‹å†¬', 'å°é›ª', 'å¤§é›ª'];
    const jqIdx = jqNames.indexOf(jqName);
    
    // Calculate Futou and Yuan (Upper, Mid, Lower)
    // Formula: order within 60-cycle
    // Use lunar-javascript date diff for robust counting
    const solar = lunar.getSolar();
    const baseDate = new Date(1900, 0, 1);
    const targetDate = new Date(solar.getYear(), solar.getMonth()-1, solar.getDay());
    const days = Math.floor((targetDate - baseDate) / 86400000);
    const order = (10 + days) % 60;
    const sy = Math.floor((order % 15) / 5);

    const dun = jqIdx < 12 ? 'é˜³é' : 'é˜´é';
    const ju = jqTable[jqIdx][sy];
    
    return { dun, ju, sy: ['ä¸Šå…ƒ', 'ä¸­å…ƒ', 'ä¸‹å…ƒ'][sy], jqName };
}

function calculateCS(gan, gong) {
    const starts = {'ç”²':'äº¥', 'ä¹™':'åˆ', 'ä¸™':'å¯…', 'ä¸':'é…‰', 'æˆŠ':'å¯…', 'å·±':'é…‰', 'åºš':'å·³', 'è¾›':'å­', 'å£¬':'ç”³', 'ç™¸':'å¯'};
    const dirs = {'ç”²':1, 'ä¹™':-1, 'ä¸™':1, 'ä¸':-1, 'æˆŠ':1, 'å·±':-1, 'åºš':1, 'è¾›':-1, 'å£¬':1, 'ç™¸':-1};
    if (!starts[gan]) return "";
    
    const branchMap = { 1: ['å­'], 8: ['ä¸‘','å¯…'], 3: ['å¯'], 4: ['è¾°','å·³'], 9: ['åˆ'], 2: ['æœª','ç”³'], 7: ['é…‰'], 6: ['æˆŒ','äº¥'], 5: ['æœª','ç”³'] };
    const targets = branchMap[gong];
    const states = ["é•¿ç”Ÿ", "æ²æµ´", "å† å¸¦", "ä¸´å®˜", "å¸æ—º", "è¡°", "ç—…", "æ­»", "å¢“", "ç»", "èƒ", "å…»"];
    const startIdx = DIZHI.indexOf(starts[gan]);
    
    let res = targets.map(t => {
        const tIdx = DIZHI.indexOf(t);
        const step = dirs[gan] === 1 ? (tIdx - startIdx + 12) % 12 : (startIdx - tIdx + 12) % 12;
        return states[step];
    });
    
    if (res.length === 1) return res[0];
    return res[0].substring(0,1) + res[1].substring(0,1);
}

function calculateSihai(jg, result) {
    const marks = {};
    const menPoMap = { 'ä¼¤é—¨': [2, 8], 'æœé—¨': [2, 8], 'å¼€é—¨': [3, 4], 'æƒŠé—¨': [3, 4], 'ä¼‘é—¨': [9], 'æ™¯é—¨': [6, 7], 'ç”Ÿé—¨': [1], 'æ­»é—¨': [1] };
    const jixingMap = { 'å·±': [2], 'æˆŠ': [3], 'å£¬': [4], 'ç™¸': [4], 'åºš': [8], 'è¾›': [9] };
    const rumuMap = { 'ç”²': [2], 'ç™¸': [2], 'ä¹™': [6], 'ä¸™': [6], 'æˆŠ': [6], 'ä¸': [8], 'å·±': [8], 'åºš': [8], 'è¾›': [4], 'å£¬': [4] };

    for (let g = 1; g <= 9; g++) {
        if (g === 5) continue;
        const info = jg[g];
        const m = { tags: [], gan_tags: {} };
        
        // é—¨è¿«
        if (menPoMap[info.men] && menPoMap[info.men].includes(g)) m.tags.push('é—¨è¿«');
        
        // ç¬¦ä½¿
        if (info.shen === 'å€¼ç¬¦') m.tags.push('ç¬¦ä½¿');
        if (info.men === result.zhishi) m.tags.push('ç¬¦ä½¿');

        // å‡»åˆ‘ & å…¥å¢“ (å¤©ç›˜/åœ°ç›˜/å¼•å¹²)
        const gans = [info.tp, info.dp, info.yingan];
        gans.forEach(gan => {
            if (!gan) return;
            const t = [];
            if (jixingMap[gan] && jixingMap[gan].includes(g)) t.push('å‡»åˆ‘');
            if (rumuMap[gan] && rumuMap[gan].includes(g)) t.push('å…¥å¢“');
            m.gan_tags[gan] = t;
        });
        
        marks[g] = m;
    }
    return marks;
}

function processPaipan(date) {
    const solar = Solar.fromDate(date);
    const lunar = solar.getLunar();
    
    const hg = lunar.getTimeInGanZhi();
    const xs = getXunShou(hg);
    const dgan = getDunGan(xs);
    const { dun, ju, sy, jqName } = getJuShu(lunar);
    
    // Build DiPan
    const dp = {};
    const order = [1, 2, 3, 4, 5, 6, 7, 8, 9];
    const startIndex = order.indexOf(ju);
    SANQI_LIUYI.forEach((gan, i) => {
        const g = dun === 'é˜³é' ? order[(startIndex + i) % 9] : order[(startIndex - i + 9) % 9];
        dp[g] = gan;
    });

    const xsGong = Object.keys(dp).find(k => dp[k] === dgan);
    const xsActual = parseInt(xsGong) === 5 ? 2 : parseInt(xsGong);
    
    const zhifu = JIUXING_ORIG[xsGong];
    const zhishi = BAMEN_ORIG[xsGong] || (parseInt(xsGong) === 5 ? 'æ­»é—¨' : '');

    // Time Branch steps for Zhishi
    const hzIdx = DIZHI.indexOf(hg[1]);
    const xsziIdx = DIZHI.indexOf(xs.substring(1));
    const stepsCount = (hzIdx - xsziIdx + 12) % 12;
    
    let currG = parseInt(xsGong);
    for (let i = 0; i < stepsCount; i++) {
        currG = dun === 'é˜³é' ? (currG === 9 ? 1 : currG + 1) : (currG === 1 ? 9 : currG - 1);
    }
    const zsTargetG = currG === 5 ? 2 : currG;

    // Time Gan for Zhifu (Rotation)
    const hgan = hg[0];
    const sg = hgan === 'ç”²' ? dgan : hgan;
    const sgGong = Object.keys(dp).find(k => dp[k] === sg);
    const sgActual = parseInt(sgGong) === 5 ? 2 : parseInt(sgGong);
    
    const getPos = g => ZHUANPAN_ORDER.indexOf(g === 5 ? 2 : g);
    const xingSteps = (getPos(sgActual) - getPos(xsActual) + 8) % 8;
    const menSteps = (getPos(zsTargetG) - getPos(xsActual) + 8) % 8;

    const jg = {};
    for (let g = 1; g <= 9; g++) {
        if (g === 5) {
            jg[g] = { name: 'ä¸­äº”å®«', dp: dp[5], yingan: '' };
            continue;
        }
        const pos = ZHUANPAN_ORDER.indexOf(g);
        
        // Stars
        const srcXingG = ZHUANPAN_ORDER[(pos - xingSteps + 8) % 8];
        const xing = JIUXING_ORIG[srcXingG];
        
        // TP Gan
        const srcTPG = ZHUANPAN_ORDER[(pos - xingSteps + 8) % 8];
        const tp = dp[srcTPG];
        
        // Men
        const srcMenG = ZHUANPAN_ORDER[(pos - menSteps + 8) % 8];
        let men = BAMEN_ORIG[srcMenG] || 'æ­»é—¨';

        // Shen
        const shenIdx = dun === 'é˜³é' ? (pos - getPos(sgActual) + 8) % 8 : (getPos(sgActual) - pos + 8) % 8;
        const shen = BASHEN[shenIdx];

        jg[g] = { dp: dp[g], tp, xing, men, shen };
    }
    
    // Yingan (Hidden Gan) - Simplification: for demo, use æ—¶å¹² from valueä½¿
    const getFlying = (start, ganIdx, dunType) => {
        const res = {};
        for(let i=0; i<9; i++){
            const curr = dunType === 'é˜³é' ? (start + i - 1) % 9 + 1 : (start - i + 9 - 1) % 9 + 1;
            res[curr] = SANQI_LIUYI[(ganIdx + i) % 9];
        }
        return res;
    };
    const sgIdx = SANQI_LIUYI.indexOf(sg);
    const yinganMap = getFlying(zsTargetG, sgIdx, dun);
    for(let g=1; g<=9; g++) jg[g].yingan = yinganMap[g];

    // Xunkong & Yima
    const xk = lunar.getXunKong();
    const yiMaMap = { 'ç”³': 8, 'å­': 8, 'è¾°': 8, 'å¯…': 2, 'åˆ': 2, 'æˆŒ': 2, 'å·³': 6, 'é…‰': 6, 'ä¸‘': 6, 'äº¥': 4, 'å¯': 4, 'æœª': 4 };
    const yima = yiMaMap[hg[1]];

    return { 
        lunar, jg, zhifu, zhishi, xunshou: xs, dungan: dgan, 
        dun, ju, sy, jqName, xunkong: xk, yima,
        marks: calculateSihai(jg, { zhishi }) 
    };
}

// ---------- UI Rendering ----------

function renderChart(result) {
    const grid = document.getElementById('qimen-grid');
    grid.innerHTML = '';
    
    // Update labels
    document.getElementById('jieqi-val').innerText = result.jqName;
    document.getElementById('jushu-val').innerText = result.dun + result.ju + "å±€ (" + result.sy + ")";
    document.getElementById('xunshou-val').innerText = result.xunshou;
    document.getElementById('zhifu-val').innerText = result.zhifu;
    document.getElementById('zhishi-val').innerText = result.zhishi;
    document.getElementById('xunkong-val').innerText = result.xunkong;
    document.getElementById('yima-val').innerText = ["å1","å¤2","éœ‡3","å·½4","ä¸­5","ä¹¾6","å…‘7","è‰®8","ç¦»9"][result.yima-1];
    
    updateGanzhiDisplay(result.lunar);
    
    const layout = [4, 9, 2, 3, 5, 7, 8, 1, 6];
    layout.forEach(gn => {
        const info = result.jg[gn];
        const m = result.marks[gn] || { tags: [], gan_tags: {} };
        const isXk = result.xunkong.includes(DIZHI[["",0,7,2,4,0,10,8,1,6][gn]]); // Rough zhi mapping
        
        const wrapper = document.createElement('div');
        wrapper.className = 'palace-wrapper';
        wrapper.onclick = () => showPalaceDetail(gn, result);
        
        if (gn === 5) {
            wrapper.innerHTML = `<div class="palace" style="justify-content:center; align-items:center;">
                <span style="color:#aaa">${info.yingan || ''}</span>
                <span class="p-stem" style="color:#666">${info.dp}</span>
            </div>`;
            grid.appendChild(wrapper);
            return;
        }

        const xkCirc = isXk ? '<span class="circle">â—‹</span>' : '';
        const maIcon = gn === result.yima ? '<span class="ma-ext">ğŸ</span>' : '';
        
        // Tags Style
        const getStyle = tags => {
            if (tags.includes('å‡»åˆ‘')) return 'color:#8b00cc; font-weight:bold;';
            if (tags.includes('é—¨è¿«')) return 'color:#cc0000; font-weight:bold;';
            if (tags.includes('å…¥å¢“')) return 'color:#cc8800; font-weight:bold;';
            if (tags.includes('ç¬¦ä½¿')) return 'color:#00bfa5; font-weight:bold;';
            return '';
        };

        const tpTags = m.gan_tags[info.tp] || [];
        const dpTags = m.gan_tags[info.dp] || [];
        
        const badge = document.createElement('div');
        badge.className = 'naji-badge';
        badge.style.display = 'none';
        badge.innerText = 'çº³å‰';
        badge.onclick = (e) => { e.stopPropagation(); showNajiDetail(gn, result); };
        wrapper.appendChild(badge);

        const palaceHTML = `
            <div class="palace">
                <div class="p-row">
                    <div class="p-left"><span class="p-shen">${xkCirc}${info.shen}</span></div>
                    <div class="p-right">${maIcon}</div>
                </div>
                <div class="p-row">
                    <div class="p-left">
                        <span class="p-yingan">${info.yingan}</span>
                        <span class="p-xing">${info.xing}</span>
                    </div>
                    <div class="p-right">
                        <div class="p-stem-layer">
                            <div class="stem-group">
                                <span class="cs-label">${calculateCS(info.tp, gn)}</span>
                                <span class="p-stem" style="${getStyle(tpTags)}">${info.tp}</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="p-row">
                    <div class="p-left"><span class="p-men" style="${getStyle(m.tags)}">${info.men}</span></div>
                    <div class="p-right">
                        <div class="stem-group">
                            <span class="cs-label">${calculateCS(info.dp, gn)}</span>
                            <span class="p-stem" style="${getStyle(dpTags)}">${info.dp}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        wrapper.innerHTML += palaceHTML;
        grid.appendChild(wrapper);
    });
}

// ---------- Event Handlers ----------

function resetToNow() {
    currentDate = new Date();
    document.getElementById('custom-dt').value = currentDate.toISOString().substring(0,16);
    renderChart(processPaipan(currentDate));
}

function jumpToDate() {
    const val = document.getElementById('custom-dt').value;
    if (val) {
        currentDate = new Date(val);
        renderChart(processPaipan(currentDate));
    }
}

function stepTime(h) {
    currentDate.setHours(currentDate.getHours() + h);
    document.getElementById('custom-dt').value = new Date(currentDate.getTime() - currentDate.getTimezoneOffset() * 60000).toISOString().substring(0,16);
    renderChart(processPaipan(currentDate));
}

function toggleCS() {
    document.body.classList.toggle('show-cs');
    showToast(document.body.classList.contains('show-cs') ? 'å·²æ˜¾ç¤ºé•¿ç”ŸçŠ¶æ€' : 'å·²éšè—é•¿ç”ŸçŠ¶æ€');
}

function toggleNaji() {
    const btn = document.getElementById('nav-naji');
    const isActive = btn.classList.toggle('active-nj');
    const badges = document.querySelectorAll('.naji-badge');
    
    let found = false;
    badges.forEach(b => {
        // Quick check for Naji rules (simple demo version)
        // In real logic, we'd check SiHai here.
        const gn = [...b.parentNode.parentNode.children].indexOf(b.parentNode); // This is wrong because of fixed layout, but for demo we just show them
        b.style.display = isActive ? 'flex' : 'none';
        found = true;
    });
    
    if (isActive && !found) showToast('å½“å‰æ—¶æ®µæš‚æ— æ¨èå‰ä½');
}

function showPalaceDetail(gn, result) {
    const info = result.jg[gn];
    document.getElementById('palace-title').innerText = ["","åä¸€å®«","å¤äºŒå®«","éœ‡ä¸‰å®«","å·½å››å®«","ä¸­äº”å®«","ä¹¾å…­å®«","å…‘ä¸ƒå®«","è‰®å…«å®«","ç¦»ä¹å®«"][gn];
    document.getElementById('palace-content').innerHTML = `
        <div style="line-height:2">
            <b>å¤©å¹²ç»„åˆï¼š</b> ${info.tp} + ${info.dp} <br>
            <b>æ ¼å±€æç¤ºï¼š</b> æ­¤å¤„å¯æ¥å…¥åç«¯æ ¼å±€ç®—æ³•æç¤º... <br>
            <hr>
            <b>å®«ä½ç‰©è±¡ï¼š</b> ${gn === 1 ? 'æ°´ã€æš—å¤„ã€é±¼ã€é¥®æ–™' : 'ç»¼åˆåˆ¤å®šä¸­...'}
        </div>
    `;
    document.getElementById('palaceModal').style.display = 'block';
}

function showNajiDetail(gn, result) {
    const info = result.jg[gn];
    const actMap = { 'ä¼‘é—¨': 'å»ºè®®ï¼šå¬èˆ’ç¼“éŸ³ä¹ã€ä¼‘æ¯æ²æµ´ã€‚', 'ç”Ÿé—¨': 'å»ºè®®ï¼šæ•´ç†é’±åŒ…ã€ç†è´¢è§„åˆ’ã€ç§æ¤ç›†æ ½ã€‚', 'å¼€é—¨': 'å»ºè®®ï¼šå‡ºé—¨æ´»åŠ¨ã€å¼€å§‹æ–°ä»»åŠ¡ã€‚', 'æ™¯é—¨': 'å»ºè®®ï¼šæ‰“æ‰«å«ç”Ÿã€å¼€ç¯ã€çœ‹æ˜äº®çš„ç”»ã€‚' };
    const act = actMap[info.men] || 'å»ºè®®ï¼šé™åä¿®æŒã€æŠ„ç»å¿µä½›ã€‚';
    
    document.getElementById('naji-content').innerHTML = `
        <h3 style="color:#28a745">çº³å‰æ–¹æ¡ˆ - ${["","åä½","å¤ä½","éœ‡ä½","å·½ä½","ä¸­å®«","ä¹¾ä½","å…‘ä½","è‰®ä½","ç¦»ä½"][gn]}</h3>
        <p><b>ã€é¢œè‰²æŒ‡ç¤ºã€‘</b> ${NAJI_COLORS[info.tp]}è‰²(ä¸Š) - ${NAJI_COLORS[info.dp]}è‰²(ä¸‹)</p>
        <p><b>ã€å…·ä½“è¡Œä¸ºã€‘</b> ${act}</p>
        <p style="font-size:0.8rem; color:#999; margin-top:20px;">* çº³å‰åŸºäºæ’ç›˜ç»„åˆé¿å¼€é—¨è¿«ã€å‡»åˆ‘ã€å…¥å¢“ç­‰å› ç´ ç»™å‡ºå»ºè®®ã€‚</p>
    `;
    document.getElementById('najiModal').style.display = 'block';
}

function showToast(msg) {
    const t = document.getElementById('toast');
    t.innerText = msg;
    t.style.display = 'block';
    setTimeout(() => t.style.display = 'none', 2000);
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }
function showHelp() { document.getElementById('helpModal').style.display = 'block'; }

function shareChart() {
    showToast('æ­£åœ¨ç”Ÿæˆåˆ†äº«å›¾...');
    html2canvas(document.body).then(canvas => {
        const link = document.createElement('a');
        link.download = 'å¥‡é—¨æ’ç›˜_' + new Date().getTime() + '.png';
        link.href = canvas.toDataURL();
        link.click();
    });
}

// Init
window.onclick = e => { if(e.target.className==='modal') e.target.style.display='none'; };
resetToNow();

</script>
</body>
</html>
