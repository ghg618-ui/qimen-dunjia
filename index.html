<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>å¥‡é—¨éç”² - æ™ºèƒ½éšèº«ç³»ç»Ÿ v2.2</title>
    <script src="https://cdn.jsdelivr.net/npm/lunar-javascript/lunar.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/sql-wasm.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&display=swap');

        :root {
            --primary: #b8905b;
            --accent: #00bfa5;
            --bg: #f5f2ed;
            --white: #ffffff;
        }

        body {
            background: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0;
            margin: 0;
            -webkit-tap-highlight-color: transparent;
            min-height: 100vh;
            color: #333;
        }

        .app-header {
            background: var(--white);
            width: 100%;
            padding: 18px 0 10px;
            text-align: center;
            border-bottom: 1px solid #e5e0da;
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.02);
        }

        .app-header h1 {
            margin: 0;
            font-size: 1.6rem;
            letter-spacing: 6px;
            font-family: 'Ma Shan Zheng', cursive;
            color: #222;
        }

        .v-tag {
            font-size: 0.6rem;
            color: #ccc;
            vertical-align: middle;
            margin-left: -10px;
            font-family: sans-serif;
            font-weight: normal;
            letter-spacing: 0;
        }

        .safe-area {
            width: 100%;
            max-width: 500px;
            padding: 20px 16px 140px;
            box-sizing: border-box;
        }

        .matter-box {
            background: var(--white);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            border: 1px solid #dcd3d1;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }

        .matter-input {
            width: 100%;
            border: none;
            font-size: 1.2rem;
            color: var(--primary);
            font-weight: bold;
            text-align: center;
            outline: none;
            background: transparent;
        }

        .chart-card {
            background: var(--white);
            border-radius: 16px;
            border: 1px solid #dcd3d1;
            padding: 18px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 16px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f9f6f2;
            font-size: 0.95rem;
        }

        .label {
            color: #999;
            font-size: 0.85rem;
        }

        .value {
            color: #333;
            font-weight: 500;
        }

        .value.highlight {
            color: var(--primary);
            font-weight: bold;
        }

        .value.red {
            color: #d32f2f;
            font-weight: bold;
        }

        .bazi-row {
            display: flex;
            gap: 12px;
            margin: 16px 0;
            text-align: center;
            padding: 14px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
        }

        .bazi-item {
            flex: 1;
        }

        .bazi-l {
            font-size: 0.75rem;
            color: #999;
            margin-bottom: 6px;
        }

        .bazi-v {
            font-size: 1.6rem;
            color: #d32f2f;
            font-weight: bold;
        }

        .bazi-v.green {
            color: #2e7d32;
        }

        .grid-container {
            width: 100%;
            background: #444;
            border: 3px solid #444;
            border-radius: 12px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-auto-rows: minmax(130px, auto);
            gap: 2px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .palace {
            background: var(--white);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 10px;
            box-sizing: border-box;
            position: relative;
            cursor: pointer;
        }

        .p-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 33.3%;
        }

        .p-unit {
            font-size: 1rem;
            color: #444;
        }

        .p-men {
            font-weight: 900;
            font-size: 1.25rem;
        }

        .p-stem {
            font-size: 1.6rem;
            font-weight: bold;
            font-family: serif;
            line-height: 1;
        }

        .p-yg {
            color: #bbb;
            font-size: 0.85rem;
            margin-right: 2px;
        }

        .xk-o {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.1rem;
            margin-right: 2px;
        }

        .cs-label {
            font-size: 0.65rem;
            color: #999;
            display: none;
            margin-bottom: 2px;
        }

        .nav-tab {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100%;
            max-width: 500px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            padding: 12px 0 34px;
            z-index: 2000;
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.08);
        }

        .nav-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #999;
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-btn.active {
            color: var(--primary);
        }

        .nav-btn.nj-on {
            color: var(--accent);
            font-weight: bold;
        }

        .nav-icon {
            font-size: 1.5rem;
            margin-bottom: 4px;
        }

        .nav-text {
            font-size: 0.75rem;
        }

        .btn-m {
            flex: 1;
            padding: 14px;
            border-radius: 12px;
            border: none;
            font-weight: bold;
            background: var(--accent);
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 191, 165, 0.2);
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 5000;
            backdrop-filter: blur(4px);
        }

        .modal-body {
            background: var(--white);
            border-radius: 28px 28px 0 0;
            width: 100%;
            max-width: 500px;
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 30px 20px 50px;
            max-height: 80vh;
            overflow-y: auto;
            box-sizing: border-box;
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.1);
        }

        .nj-bd {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border: 2.5px solid var(--accent);
            background: white;
            border-radius: 10px;
            padding: 6px 12px;
            color: var(--accent);
            font-weight: bold;
            font-size: 0.95rem;
            display: none;
            z-index: 10;
            pointer-events: none;
            box-shadow: 0 6px 15px rgba(0, 191, 165, 0.25);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(1);
                box-shadow: 0 0 0 0 rgba(0, 191, 165, 0.4);
            }

            70% {
                transform: translate(-50%, -50%) scale(1.05);
                box-shadow: 0 0 0 10px rgba(0, 191, 165, 0);
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        #toast {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.9);
            color: #fff;
            padding: 12px 28px;
            border-radius: 50px;
            display: none;
            z-index: 10000;
            font-size: 0.9rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .case-item {
            padding: 18px;
            border-bottom: 1px solid #f9f6f2;
            cursor: pointer;
            transition: 0.2s;
        }

        .case-item:hover {
            background: #fdfaf5;
        }

        .case-n {
            font-weight: bold;
            color: #222;
            font-size: 1.1rem;
        }

        .case-t {
            font-size: 0.85rem;
            color: #999;
            margin-top: 6px;
        }

        #note-card {
            background: white;
            border-radius: 16px;
            padding: 18px;
            margin-top: 16px;
            border: 1px solid #e5e0da;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.03);
            display: none;
        }

        .nj-sec {
            margin-bottom: 12px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
        }

        .nj-lbl {
            color: #b8905b;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
            font-size: 0.9rem;
        }

        .nj-val {
            color: #444;
            line-height: 1.5;
            font-size: 1rem;
        }
    </style>
</head>

<body>
    <div class="app-header">
        <h1>å¥‡é—¨éç”²<span class="v-tag">v2.2 Stable</span></h1>
    </div>
    <div class="safe-area">
        <div class="matter-box"><input type="text" id="matter" class="matter-input" placeholder="è¾“å…¥é¢„æµ‹äº‹é¡¹..."></div>
        <div class="chart-card">
            <div class="info-row"><span class="label">æ—¥æœŸ</span><span class="value"
                    style="display:flex;align-items:center;"><input type="datetime-local" id="dt-pk"
                        style="border:none;outline:none;font-size:1.1rem;color:#c02;font-weight:bold;background:transparent;"><button
                        onclick="pk()"
                        style="background:var(--accent);color:#fff;border:none;border-radius:8px;padding:6px 14px;margin-left:8px;font-weight:bold;">æ’ç›˜</button></span>
            </div>
            <div class="bazi-row">
                <div class="bazi-item">
                    <div class="bazi-l">å¹´æŸ±</div>
                    <div class="bazi-v" id="bz-y">--</div>
                </div>
                <div class="bazi-item">
                    <div class="bazi-l">æœˆæŸ±</div>
                    <div class="bazi-v green" id="bz-m">--</div>
                </div>
                <div class="bazi-item">
                    <div class="bazi-l">æ—¥æŸ±</div>
                    <div class="bazi-v green" id="bz-d">--</div>
                </div>
                <div class="bazi-item">
                    <div class="bazi-l">æ—¶æŸ±</div>
                    <div class="bazi-v" id="bz-t">--</div>
                </div>
            </div>
            <div class="info-row"><span class="label">èŠ‚æ°”</span><span class="value" id="jq-v">--</span></div>
            <div class="info-row"><span class="label">å±€æ•°</span><span class="value highlight" id="js-v">--</span><span
                    class="label">æ—¬é¦–</span><span class="value highlight" id="xs-v">--</span></div>
            <div class="info-row"><span class="label">å€¼ç¬¦å€¼ä½¿</span><span class="value" id="zfzs-v"
                    style="color:var(--primary)">--</span></div>
            <div class="info-row"><span class="label">ç©ºäº¡é©¬æ˜Ÿ</span><span class="value red" id="xkm-v">--</span></div>
        </div>
        <div class="grid-container" id="grid"></div>
        <div id="note-card">
            <div
                style="font-weight:bold;color:var(--primary);margin-bottom:8px;border-bottom:1px solid #f5f2ed;padding-bottom:5px;">
                æ¡£æ¡ˆç¬”è®°</div>
            <div id="note-body" style="font-size:0.95rem; line-height:1.6; color:#555; white-space:pre-wrap;"></div>
        </div>
        <div class="action-btns" style="display:flex;gap:12px;margin-top:20px;"><button class="btn-m"
                onclick="step(-2)">â—€ ä¸Šä¸€å±€</button><button class="btn-m" style="background:#8b7355"
                onclick="toggleCS()">æ˜¾ç¤ºé•¿ç”Ÿ</button><button class="btn-m" onclick="step(2)">ä¸‹ä¸€å±€ â–¶</button></div>
    </div>
    <div class="nav-tab">
        <div class="nav-btn active" onclick="goNow()"><span class="nav-icon">ğŸ•’</span><span class="nav-text">ç°åœ¨</span>
        </div>
        <div class="nav-btn" onclick="openLib()"><span class="nav-icon">ğŸ“‚</span><span class="nav-text">æ¡£æ¡ˆ</span></div>
        <div class="nav-btn" id="nj-btn" onclick="toggleNJ()"><span class="nav-icon">âœ¨</span><span
                class="nav-text">çº³å‰</span></div>
        <div class="nav-btn" onclick="share()"><span class="nav-icon">ğŸ–¼ï¸</span><span class="nav-text">åˆ†äº«</span></div>
    </div>
    <div id="lib-modal" class="modal">
        <div class="modal-body"><span
                style="position:absolute;top:15px;right:20px;font-size:1.5rem;color:#ccc;cursor:pointer;"
                onclick="closeM('lib-modal')">&times;</span>
            <h3 style="color:var(--primary);margin:0 0 20px;text-align:center;">æ¡£æ¡ˆåº“æ¥å…¥</h3>
            <div id="drop-box"
                style="border:2.5px dashed #ccc;border-radius:20px;padding:45px 20px;text-align:center;color:#999;margin-bottom:20px;cursor:pointer;background:#fafafa;">
                ğŸ“‚ ç‚¹å‡»æˆ–æ‹–æ‹½ cases.db æ¢å¤æ•°æ®</div>
            <div id="c-list"></div>
        </div>
    </div>
    <div id="p-modal" class="modal">
        <div class="modal-body"><span
                style="position:absolute;top:15px;right:20px;font-size:1.5rem;color:#ccc;cursor:pointer;"
                onclick="closeM('p-modal')">&times;</span>
            <h3 id="p-t" style="color:var(--primary);margin:0 0 15px;">å®«ä½è¯¦æ</h3>
            <div id="p-c"></div>
        </div>
    </div>
    <div id="toast"></div>
    <script>
        const TI = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'], DI = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'], SQ = ['æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸', 'ä¸', 'ä¸™', 'ä¹™'], ZO = [1, 8, 3, 4, 9, 2, 7, 6], BO = { 1: 'ä¼‘é—¨', 2: 'æ­»é—¨', 3: 'ä¼¤é—¨', 4: 'æœé—¨', 6: 'å¼€é—¨', 7: 'æƒŠé—¨', 8: 'ç”Ÿé—¨', 9: 'æ™¯é—¨' }, XO = { 1: 'å¤©è“¬', 2: 'å¤©èŠ®', 3: 'å¤©å†²', 4: 'å¤©è¾…', 5: 'å¤©ç¦½', 6: 'å¤©å¿ƒ', 7: 'å¤©æŸ±', 8: 'å¤©ä»»', 9: 'å¤©è‹±' }, BS = ['å€¼ç¬¦', 'è£è›‡', 'å¤ªé˜´', 'å…­åˆ', 'ç™½è™', 'ç„æ­¦', 'ä¹åœ°', 'ä¹å¤©'];
        const WX_DATA = { "ç”²": "é¾™ã€é«˜è´µç‰©å“", "ä¹™": "èŠ±è‰ã€è‰ºæœ¯å“ã€ç®¡é“", "ä¸™": "é•œå­ã€çº¢ç«ã€å°ç« ", "ä¸": "ç¯ç«ã€åˆ©åˆƒã€é¦™ç«", "æˆŠ": "é’±å¸ã€é™¶ç“·ã€ç†è´¢", "å·±": "åå«ã€åƒåœ¾ã€æ—§ç»³", "åºš": "å¤§åˆ€ã€å™¨æ¢°ã€ç¡¬çŸ³", "è¾›": "ç å®ã€é¢—ç²’ã€å¯†é’¥", "å£¬": "æ°´ç®¡ã€æ±Ÿæ²³ã€æµé€š", "ç™¸": "æ¸…èŒ¶ã€é…’æ°´ã€å•æµ´", "ä¼‘é—¨": "æ°´ã€è´µäºº", "ç”Ÿé—¨": "è´¢åº“ã€ç”Ÿæœº", "æ­»é—¨": "å¢“ç¢‘ã€æ­»ç‰©", "æ™¯é—¨": "æ–‡ä¹¦ã€ç”µå™¨" };
        const XW_DATA = { "ç”²": "é«˜çº§è£…æ‰®", "ä¹™": "æ‰‹å†™æ—¥è®°ã€ç†è‰", "ä¸™": "ç‚¹äº®ç¯å…‰ã€ç…§é•œ", "ä¸": "å¸ç®¡å–æ°´ã€è¯µç»", "æˆŠ": "æ•´ç†é’±åŒ…ã€åƒè‚‰", "å·±": "å°é›¶é£Ÿã€é™å", "åºš": "æŠ„ç»é˜…è¯»ã€å†³æ–­", "è¾›": "å¿æ‚”æ”¹å˜ã€åƒè¾£", "å£¬": "è·‘æ­¥å–æ°´ã€æ¸…æ´—", "ç™¸": "æ´—è„¸å–èŒ¶ã€è¡Œèµ°", "å€¼ç¬¦": "ç©¿æˆ´å¤§æ–¹", "å¤ªé˜´": "ç´ å‡€å…¸é›…", "ä¼‘é—¨": "æ”¾æ¾æ²æµ´", "ç”Ÿé—¨": "æ±‚è´¢è§„åˆ’", "å¼€é—¨": "æ­£å¼å·¥ä½œ", "æ™¯é—¨": "ç‚¹é¦™è–°ç¯" };
        const GUA_MAP = { "6,6": "ä¹¾ä¸ºå¤©", "6,2": "å¤©åœ°å¦", "6,3": "å¤©é›·æ— å¦„", "6,4": "å¤©é£å§¤", "6,1": "å¤©æ°´è®¼", "6,9": "å¤©ç«åŒäºº", "6,8": "å¤©å±±é", "6,7": "å¤©æ³½å±¥", "2,6": "åœ°å¤©æ³°", "2,2": "å¤ä¸ºåœ°", "2,3": "åœ°é›·å¤", "2,4": "åœ°é£å‡", "2,1": "åœ°æ°´å¸ˆ", "2,9": "åœ°ç«æ˜å¤·", "2,8": "åœ°å±±è°¦", "2,7": "åœ°æ³½ä¸´", "3,6": "é›·å¤©å¤§å£®", "3,2": "é›·åœ°è±«", "3,3": "éœ‡ä¸ºé›·", "3,4": "é›·é£æ’", "3,1": "é›·æ°´è§£", "3,9": "é›·ç«ä¸°", "3,8": "é›·å±±å°è¿‡", "3,7": "é›·æ³½å½’å¦¹", "4,6": "é£å¤©å°ç•œ", "4,2": "é£åœ°è§‚", "4,3": "é£é›·ç›Š", "4,4": "å·½ä¸ºé£", "4,1": "é£æ°´æ¶£", "4,9": "é£ç«å®¶äºº", "4,8": "é£å±±æ¸", "4,7": "é£æ³½ä¸­å­š", "1,6": "æ°´å¤©éœ€", "1,2": "æ°´åœ°æ¯”", "1,3": "æ°´é›·å±¯", "1,4": "æ°´é£äº•", "1,1": "åä¸ºæ°´", "1,9": "æ°´ç«æ—¢æµ", "1,8": "æ°´å±±è¹‡", "1,7": "æ°´æ³½èŠ‚", "9,6": "ç«å¤©å¤§æœ‰", "9,2": "ç«åœ°æ™‹", "9,3": "ç«é›·å™¬å—‘", "9,4": "ç«é£é¼", "9,1": "ç«æ°´æœªæµ", "9,9": "ç¦»ä¸ºç«", "9,8": "ç«å±±æ—…", "9,7": "ç«æ³½ç½", "8,6": "å±±å¤©å¤§ç•œ", "8,2": "å±±åœ°å‰¥", "8,3": "å±±é›·é¢", "8,4": "å±±é£è›Š", "8,1": "å±±æ°´è’™", "8,9": "å±±ç«è´²", "8,8": "è‰®ä¸ºå±±", "8,7": "å±±æ³½æŸ", "7,6": "æ³½å¤©å¤¬", "7,2": "æ³½åœ°èƒ", "7,3": "æ³½é›·éš", "7,4": "æ³½é£å¤§è¿‡", "7,1": "æ³½æ°´å›°", "7,9": "æ³½ç«é©", "7,8": "æ³½å±±å’¸", "7,7": "å…‘ä¸ºæ³½" };
        const GO = { 'ä¼‘é—¨': 1, 'æ­»é—¨': 2, 'ä¼¤é—¨': 3, 'æœé—¨': 4, 'å¼€é—¨': 6, 'æƒŠé—¨': 7, 'ç”Ÿé—¨': 8, 'æ™¯é—¨': 9 };
        let cT = new Date(), sqlDB = null, showCS = false;

        function syncPK() { document.getElementById('dt-pk').value = new Date(cT.getTime() - cT.getTimezoneOffset() * 60000).toISOString().substring(0, 16); rdr(paipan(cT)); }
        function goNow() { cT = new Date(); syncPK(); }
        function pk() { const v = document.getElementById('dt-pk').value; if (v) { cT = new Date(v); rdr(paipan(cT)); } }
        function step(h) { cT.setHours(cT.getHours() + h); syncPK(); }
        function toggleCS() { showCS = !showCS; Array.from(document.querySelectorAll('.cs-label')).forEach(el => el.style.display = showCS ? 'block' : 'none'); }
        function toggleNJ() { const b = document.getElementById('nj-btn'); const a = b.classList.toggle('nj-on'); document.querySelectorAll('.nj-bd').forEach(i => i.style.display = a ? 'block' : 'none'); showT(a ? 'å·²å¼€å¯çº³å‰è§†é‡' : 'å·²å…³é—­'); }
        function showT(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); }
        function closeM(id) { document.getElementById(id).style.display = 'none'; }
        function getXS(gz) { const gi = TI.indexOf(gz[0]), zi = DI.indexOf(gz[1]); return "ç”²" + DI[(zi - gi + 12) % 12]; }
        function calcCS(g, p) { const s = { 'ç”²': 'äº¥', 'ä¹™': 'åˆ', 'ä¸™': 'å¯…', 'ä¸': 'é…‰', 'æˆŠ': 'å¯…', 'å·±': 'é…‰', 'åºš': 'å·³', 'è¾›': 'å­', 'å£¬': 'ç”³', 'ç™¸': 'å¯' }, d = { 'ç”²': 1, 'ä¹™': -1, 'ä¸™': 1, 'ä¸': -1, 'æˆŠ': 1, 'å·±': -1, 'åºš': 1, 'è¾›': -1, 'å£¬': 1, 'ç™¸': -1 }, st = ["é•¿ç”Ÿ", "æ²æµ´", "å† å¸¦", "ä¸´å®˜", "å¸æ—º", "è¡°", "ç—…", "æ­»", "å¢“", "ç»", "èƒ", "å…»"]; if (!s[g]) return ""; const t = { 1: 'å­', 8: 'å¯…', 3: 'å¯', 4: 'å·³', 9: 'åˆ', 2: 'ç”³', 7: 'é…‰', 6: 'äº¥', 5: 'ç”³' }[p]; const si = DI.indexOf(s[g]), ti = DI.indexOf(t); return st[(d[g] === 1 ? (ti - si + 12) % 12 : (si - ti + 12) % 12)]; }

        function paipan(date) {
            const sol = window.Solar.fromDate(date), lun = sol.getLunar(), hg = lun.getTimeInGanZhi(), dg_map = { 'ç”²å­': 'æˆŠ', 'ç”²æˆŒ': 'å·±', 'ç”²ç”³': 'åºš', 'ç”²åˆ': 'è¾›', 'ç”²è¾°': 'å£¬', 'ç”²å¯…': 'ç™¸' }, xs = getXS(hg), dg = dg_map[xs], jn = lun.getPrevJieQi().getName(), ji = ['å†¬è‡³', 'å°å¯’', 'å¤§å¯’', 'ç«‹æ˜¥', 'é›¨æ°´', 'æƒŠè›°', 'æ˜¥åˆ†', 'æ¸…æ˜', 'è°·é›¨', 'ç«‹å¤', 'å°æ»¡', 'èŠ’ç§', 'å¤è‡³', 'å°æš‘', 'å¤§æš‘', 'ç«‹ç§‹', 'å¤„æš‘', 'ç™½éœ²', 'ç§‹åˆ†', 'å¯’éœ²', 'éœœé™', 'ç«‹å†¬', 'å°é›ª', 'å¤§é›ª'].indexOf(jn), dayO = (10 + Math.floor((new Date(sol.getYear(), sol.getMonth() - 1, sol.getDay()) - new Date(1900, 0, 1)) / 86400000)) % 60, sy = Math.floor((dayO % 15) / 5), ju = [[1, 7, 4], [2, 8, 5], [3, 9, 6], [8, 5, 2], [9, 6, 3], [1, 7, 4], [3, 9, 6], [4, 1, 7], [5, 2, 8], [4, 1, 7], [5, 2, 8], [6, 3, 9], [9, 3, 6], [8, 2, 5], [7, 1, 4], [2, 5, 8], [1, 4, 7], [9, 3, 6], [7, 1, 4], [6, 9, 3], [5, 8, 2], [6, 9, 3], [5, 8, 2], [4, 7, 1]][ji][sy], dp = {};
            [1, 2, 3, 4, 5, 6, 7, 8, 9].forEach((g, i) => { dp[ji < 12 ? [1, 2, 3, 4, 5, 6, 7, 8, 9][([1, 2, 3, 4, 5, 6, 7, 8, 9].indexOf(ju) + i) % 9] : [1, 2, 3, 4, 5, 6, 7, 8, 9][([1, 2, 3, 4, 5, 6, 7, 8, 9].indexOf(ju) - i + 9) % 9]] = SQ[i]; });
            const xg = Object.keys(dp).find(k => dp[k] === dg), xa = xg == 5 ? 2 : parseInt(xg), sg = hg[0] === 'ç”²' ? dg : hg[0], sgG = Object.keys(dp).find(k => dp[k] === sg), sa = sgG == 5 ? 2 : parseInt(sgG), st = (DI.indexOf(hg[1]) - DI.indexOf(xs.substring(1)) + 12) % 12; let cg = parseInt(xg); for (let i = 0; i < st; i++)cg = ji < 12 ? (cg == 9 ? 1 : cg + 1) : (cg == 1 ? 9 : cg - 1);
            const zt = cg == 5 ? 2 : cg, zp = ZO.indexOf(zt), xp = ZO.indexOf(xa), sp = ZO.indexOf(sa), jg = {}, zs = BO[xg] || 'æ­»é—¨';
            for (let n = 1; n <= 9; n++) { if (n == 5) { jg[n] = { dp: dp[5], yg: '' }; continue; } const p = ZO.indexOf(n), xiG = ZO[(p - (sp - xp + 8) % 8 + 8) % 8], meG = ZO[(p - (zp - xp + 8) % 8 + 8) % 8]; jg[n] = { dp: dp[n], tp: dp[xiG] || dp[5], xi: XO[xiG], me: BO[meG] || 'æ­»é—¨', sn: BS[ji < 12 ? (p - sp + 8) % 8 : (sp - p + 8) % 8] }; }
            const ym = {}; for (let i = 0; i < 9; i++)ym[ji < 12 ? (zt + i - 1) % 9 + 1 : (zt - i + 9 - 1) % 9 + 1] = SQ[(SQ.indexOf(sg) + i) % 9]; for (let n = 1; n <= 9; n++)jg[n].yg = ym[n];
            const mk = {}; for (let n = 1; n <= 9; n++) { if (n == 5) continue; const m = { ts: [], gt: {} }; if (['ä¼¤é—¨', 'æœé—¨'].includes(jg[n].me) && [2, 8].includes(n)) m.ts.push('é—¨è¿«'); if (['å¼€é—¨', 'æƒŠé—¨'].includes(jg[n].me) && [3, 4].includes(n)) m.ts.push('é—¨è¿«');[jg[n].tp, jg[n].dp, jg[n].yg].forEach(gan => { const t = []; if ({ 'å·±': [2], 'æˆŠ': [3], 'å£¬': [4], 'ç™¸': [4], 'åºš': [8], 'è¾›': [9] }[gan]?.includes(n)) t.push('å‡»åˆ‘'); if ({ 'ç”²': [2], 'ç™¸': [2], 'ä¹™': [6], 'ä¸™': [6], 'æˆŠ': [6], 'ä¸': [8], 'å·±': [8], 'åºš': [8], 'è¾›': [4], 'å£¬': [4] }[gan]?.includes(n)) t.push('å…¥å¢“'); m.gt[gan] = t; }); mk[n] = m; }
            return { lu: lun, jg, zf: XO[xa], zs, xs, du: ji < 12 ? 'é˜³é' : 'é˜´é', ju, sy: ['ä¸Šå…ƒ', 'ä¸­å…ƒ', 'ä¸‹å…ƒ'][sy], jq: jn, xk: lun.getEightChar().getDayXunKong(), ym: { 'ç”³': 8, 'å­': 8, 'è¾°': 8, 'å¯…': 2, 'åˆ': 2, 'æˆŒ': 2, 'å·³': 6, 'é…‰': 6, 'ä¸‘': 6, 'äº¥': 4, 'å¯': 4, 'æœª': 4 }[hg[1]], mk };
        }

        function shP(n, r) {
            const f = r.jg[n], pi = ["", "åä¸€å®«", "å¤2å®«", "éœ‡ä¸‰å®«", "å·½å››å®«", "ä¸­äº”å®«", "ä¹¾å…­å®«", "å…‘ä¸ƒå®«", "è‰®å…«å®«", "ç¦»ä¹å®«"][n];
            document.getElementById('p-t').innerText = pi;
            let h = `<div class="nj-sec"><span class="nj-lbl">ã€ä¹å®«åˆ†æã€‘</span><span class="nj-val">${f.sn} + ${f.xi} + ${f.me}</span></div>`;
            if (GO[f.me]) { const gn = GO[f.me]; const gn_name = GUA_MAP[`${gn},${n}`] || `å¦ä½(${gn},${n})`; h += `<div class="nj-sec"><span class="nj-lbl">ã€é—¨å®«å¦ã€‘</span><span class="nj-val">${gn_name}</span></div>`; }

            // æ ¼å±€æç¤º
            const combo = f.tp + f.dp;
            let geju = [];
            if (['æˆŠåºš', 'åºšæˆŠ', 'ä¹™è¾›', 'è¾›ä¹™', 'ä¸™å£¬', 'å£¬ä¸™', 'ä¸ç™¸', 'ç™¸ä¸'].includes(combo)) geju.push("å¤©ç›˜å†²æ ¼");
            if (['æˆŠè¾›', 'è¾›æˆŠ', 'åºšç™¸', 'ç™¸åºš', 'å£¬å·±', 'å·±å£¬'].includes(combo)) geju.push("åœ°ç›˜å†²æ ¼");
            if (['ä¹™è¾›', 'ä¸™åºš', 'æˆŠåºš', 'åºšæˆŠ', 'åºšå£¬', 'åºšç™¸', 'ç™¸å£¬'].includes(combo)) geju.push("åŠ¨æ ¼/è¿å¾™");
            if (['ä¹™åºš', 'åºšä¹™', 'ä¸™è¾›', 'è¾›ä¸™', 'ä¸å£¬', 'å£¬ä¸', 'æˆŠç™¸', 'ç™¸æˆŠ'].includes(combo)) geju.push("åˆæ ¼/ç¾ç»Š");
            if (geju.length) h += `<div class="nj-sec"><span class="nj-lbl">ã€æ ¼å±€æç¤ºã€‘</span><span class="nj-val" style="color:#d32f2f">${geju.join('ã€')}</span></div>`;

            let acts = [XW_DATA[f.tp], XW_DATA[f.dp], XW_DATA[f.me], XW_DATA[f.sn]].filter(v => v);
            if (acts.length) h += `<div class="nj-sec"><span class="nj-lbl">ã€è¡Œä¸ºå»ºè®®ã€‘</span><span class="nj-val">${[...new Set(acts)].join('ã€')}</span></div>`;
            let wux = [WX_DATA[f.tp], WX_DATA[f.dp], WX_DATA[f.me]].filter(v => v);
            if (wux.length) h += `<div class="nj-sec"><span class="nj-lbl">ã€ç‰©è±¡å‚è€ƒã€‘</span><span class="nj-val">${[...new Set(wux)].join('ã€')}</span></div>`;
            document.getElementById('p-c').innerHTML = h; document.getElementById('p-modal').style.display = 'block';
        }

        function rdr(r) {
            if (!r) return;
            document.getElementById('jq-v').innerText = r.jq;
            document.getElementById('js-v').innerText = r.du + r.ju + 'å±€(' + r.sy + ')';
            document.getElementById('xs-v').innerText = r.xs; document.getElementById('zfzs-v').innerText = `ç¬¦ï¼š${r.zf} / ä½¿ï¼š${r.zs}`;
            document.getElementById('xkm-v').innerText = `ç©ºï¼š${r.xk} é©¬ï¼š${["", "å1", "å¤2", "éœ‡3", "å·½4", "ä¸­5", "ä¹¾6", "å…‘7", "è‰®8", "ç¦»9"][r.ym]}`;
            const bzv = [r.lu.getYearInGanZhiExact(), r.lu.getMonthInGanZhiExact(), r.lu.getDayInGanZhiExact(), r.lu.getTimeInGanZhi()];
            ['bz-y', 'bz-m', 'bz-d', 'bz-t'].forEach((id, i) => document.getElementById(id).innerText = bzv[i]);
            const g = document.getElementById('grid'); g.innerHTML = '';
            [4, 9, 2, 3, 5, 7, 8, 1, 6].forEach(n => {
                const f = r.jg[n], w = document.createElement('div'); w.className = 'palace'; w.onclick = () => shP(n, r);
                if (n === 5) { w.innerHTML = `<div style="height:100%;display:flex;justify-content:center;align-items:center;"><span class="p-stem" style="color:#ddd">${f.dp}</span></div>`; g.appendChild(w); return; }
                const getS = t => t?.includes('å‡»åˆ‘') ? 'color:#8b00cc;' : t?.includes('é—¨è¿«') ? 'color:#cc0000;' : t?.includes('å…¥å¢“') ? 'color:#cc8800' : '';
                let njH = ""; const njR = { 1: ['ä¼‘é—¨'], 2: ['ç”Ÿé—¨'], 6: ['å¼€é—¨'], 7: ['æƒŠé—¨'], 8: ['ç”Ÿé—¨'], 9: ['æ™¯é—¨'] };
                if (njR[n]?.includes(f.me) && !r.mk[n].ts.includes('é—¨è¿«') && !Object.values(r.mk[n].gt).flat().includes('å‡»åˆ‘') && f.sn !== 'ç™½è™' && !r.xk.includes(DI[["", 0, 7, 2, 4, 0, 10, 8, 1, 6][n]])) {
                    njH = `<div class="nj-bd" style="display:${document.getElementById('nj-btn').classList.contains('nj-on') ? 'block' : 'none'}">çº³å‰</div>`;
                }
                w.innerHTML = `${njH}<div class="p-row"><span class="p-unit">${r.xk.includes(DI[["", 0, 7, 2, 4, 0, 10, 8, 1, 6][n]]) ? '<span class="xk-o">â—‹</span>' : ''}${f.sn}</span><span>${n === r.ym ? 'ğŸ' : ''}</span></div><div class="p-row"><div><span class="p-yg">${f.yg}</span><span class="p-unit">${f.xi}</span></div><div style="text-align:right"><span class="cs-label" style="display:${showCS ? 'block' : 'none'}">${calcCS(f.tp, n)}</span><span class="p-stem" style="${getS(r.mk[n].gt[f.tp])}">${f.tp}</span></div></div><div class="p-row"><span class="p-men" style="${getS(r.mk[n].ts)}">${f.me}</span><div style="text-align:right"><span class="cs-label" style="display:${showCS ? 'block' : 'none'}">${calcCS(f.dp, n)}</span><span class="p-stem" style="${getS(r.mk[n].gt[f.dp])}">${f.dp}</span></div></div>`;
                g.appendChild(w);
            });
        }

        async function saveDB(arrayBuffer) { const db = await indexedDB.open('QimenDBStore', 1); db.onupgradeneeded = e => e.target.result.createObjectStore('dbFile'); db.onsuccess = e => { const d = e.target.result; const tx = d.transaction('dbFile', 'readwrite'); tx.objectStore('dbFile').put(arrayBuffer, 'current'); }; }
        async function loadSavedDB() { const req = indexedDB.open('QimenDBStore', 1); req.onupgradeneeded = e => e.target.result.createObjectStore('dbFile'); req.onsuccess = e => { const d = e.target.result; const tx = d.transaction('dbFile', 'readonly'); tx.objectStore('dbFile').get('current').onsuccess = event => { if (event.target.result) initSQL(event.target.result); }; }; }
        async function initSQL(buffer) { const SQL = await initSqlJs({ locateFile: f => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.6.2/${f}` }); sqlDB = new SQL.Database(new Uint8Array(buffer)); const res = sqlDB.exec("SELECT name, chart_time, notes FROM cases ORDER BY chart_time DESC"); if (res.length > 0) { document.getElementById('c-list').innerHTML = res[0].values.map(v => `<div class="case-item" onclick="loadC('${v[0] || ""}' ,'${v[1]}','${v[2] || ""}')"><div class="case-n">${v[0] || 'æœªå®šäº‹é¡¹'}</div><div class="case-t">${v[1]}</div></div>`).join(''); } }
        function loadC(m, dt, n) { document.getElementById('matter').value = m; document.getElementById('dt-pk').value = dt.replace(' ', 'T'); document.getElementById('note-body').innerText = n || 'æ— ç¬”è®°'; document.getElementById('note-card').style.display = 'block'; pk(); closeM('lib-modal'); }
        function openLib() { document.getElementById('lib-modal').style.display = 'block'; }
        const drop = document.getElementById('drop-box'); drop.onclick = () => { const i = document.createElement('input'); i.type = 'file'; i.onchange = e => handleF(e.target.files[0]); i.click(); }; drop.ondragover = e => { e.preventDefault(); drop.style.borderColor = 'var(--accent)'; }; drop.ondrop = e => { e.preventDefault(); handleF(e.dataTransfer.files[0]); };
        function handleF(file) { if (!file) return; const r = new FileReader(); r.onload = e => { saveDB(e.target.result); initSQL(e.target.result); }; r.readAsArrayBuffer(file); }
        function share() { showT('ç”Ÿæˆä¸­...'); html2canvas(document.body).then(v => { const a = document.createElement('a'); a.download = 'QiMen_Card.png'; a.href = v.toDataURL(); a.click(); }); }
        window.onload = () => { syncPK(); loadSavedDB(); };
    </script>
</body>

</html>